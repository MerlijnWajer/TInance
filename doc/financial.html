<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Techinc Financial administration</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="techinc-financial-administration">
<h1 class="title">Techinc Financial administration</h1>

<p>We will start by introducing terminology and how the system works. It will later
on cover manipulating the database using command line tools and automated
processing of transactions; and finally gathering useful information.</p>
<p>A word of warning, some parts of the guide require access to private files
(mainly: the database) which are stored in another private location, since we
will not provide those to the public.</p>
<div class="section" id="what-the-system-needs-to-do">
<h1>What the system needs to do</h1>
<p>The system needs to manage member administration. This entails:</p>
<ul class="simple">
<li>Keeping track of who is a member and who is not</li>
<li>Managing payments made by members (Importing data from banks)</li>
<li>Provide reports and statistics of the above</li>
<li>Be easy and fast to manage</li>
</ul>
</div>
<div class="section" id="database">
<h1>Database</h1>
<p>The database contains two tables. One table to store information about members;
one row per member. This contains basic information such as:</p>
<ul class="simple">
<li>Email-address</li>
<li>Nickname</li>
<li>Full name</li>
<li>Date joined</li>
<li>Entrance-key ID</li>
<li>Active (or not)</li>
</ul>
<p>The other table contains the membership payments for the members, each row a
payment for one or multiple months. Every payment contains, at least:</p>
<ul class="simple">
<li>Reference to member</li>
<li>Amount of money paid</li>
<li>Amount of months paid for in this transaction (typically 1)</li>
<li>Date of the transaction</li>
<li>Optional: A hash of the transaction used for identification when importing</li>
</ul>
<p>The database is SQLite3 and stored in <tt class="docutils literal">tidb/db.db</tt>.
<strong>If the database does not exist yet, it is created by the frontend and will be
empty; you need to copy the database from the private location.</strong></p>
</div>
<div class="section" id="command-line-frontend">
<h1>Command line frontend</h1>
<p>The file <tt class="docutils literal">ti.py</tt> is the command line frontend to the database and contains
some powerful search and statistics features. The frontend currently allows one
to:</p>
<ul class="simple">
<li>Add members to the administration database</li>
<li>Activate/Deactivate members</li>
<li>Search for members</li>
<li>Print a report of payments; members who are: overdue or on time.</li>
<li>Perform JSON exports for our LDAP scripts</li>
<li>List payments per member</li>
</ul>
<p>In the near future, it will also allow:</p>
<ul class="simple">
<li>Manually adding a payment</li>
<li>Manually modifing a member and/or payment</li>
<li>Have options to generate graphs and other statistics (this is currently only
possible with other, external python scripts such as <tt class="docutils literal">stats.py</tt> and
<tt class="docutils literal">graphs.py</tt>.</li>
</ul>
<p>Simply running:</p>
<pre class="literal-block">
python ti.py --help
</pre>
<p>Should give you the main idea on how to use it. The next sections are examples
of the common commands.</p>
<p><strong>Anything that is currently not implemented can be done using sqlite3.</strong></p>
<div class="section" id="adding-a-member-to-the-system">
<h2>Adding a member to the system</h2>
<p>Use <cite>scripts/add_member.sh</cite>, or alternatively:</p>
<pre class="literal-block">
python ti.py python2 ti.py --add --nick &quot;nick&quot; --name &quot;Name&quot; \
    --email &quot;Email&quot; --date now --fobid &quot;idhere&quot;
</pre>
<p>Pick &quot;NaN&quot; if no fob is given out. The date can either be <cite>now</cite> or of
format YYYY-mm-dd.</p>
</div>
<div class="section" id="searching-for-a-member">
<h2>Searching for a member</h2>
<p>Issue:</p>
<pre class="literal-block">
python ti.py --search --nick '%nickhere%'
</pre>
<p>Alternatively, you can also search by either name, fobid or email:</p>
<pre class="literal-block">
python ti.py --search --name '%Merlijn%'
python ti.py --search --fobid '%8%'
</pre>
</div>
<div class="section" id="using-format">
<h2>Using --format</h2>
<p>From the --help:</p>
<pre class="literal-block">
Add percentage in front of the type. Allowed types:
id: i nick: n name: N mail: m join-date: j paid: p
keyid: k active: A
</pre>
<p>Thus:</p>
<pre class="literal-block">
python ti.py --search --nick wizzup -f &quot;ID: %i. FOBID: %k. NAME: %N&quot;
</pre>
</div>
<div class="section" id="deactivating-a-member">
<h2>Deactivating a member</h2>
<p>First, find the member (either by nick, name, email or fobid):</p>
<pre class="literal-block">
python ti.py --search --nick wizzup
</pre>
<p>Then deactivate:</p>
<pre class="literal-block">
python ti.py --deactivate --nick wizzup
</pre>
<p>Activating a member is the same, but use <cite>--activate</cite>.</p>
</div>
<div class="section" id="looking-at-payments">
<h2>Looking at payments</h2>
<p>To list payments of a member:</p>
<pre class="literal-block">
python ti.py --search --nick 'wizzup' --payment
</pre>
</div>
<div class="section" id="manually-adding-a-single-payment">
<h2>Manually adding a single payment</h2>
<p>TODO. Will be nothing like:</p>
<pre class="literal-block">
python ti.py --nick wizzup --add --payment --payment-months 2 --payment-amount 20 --payment-comment hai --date now
</pre>
</div>
<div class="section" id="modifying-a-single-payment">
<h2>Modifying a single payment</h2>
</div>
<div class="section" id="finding-out-which-members-are-overdue-with-their-payments">
<h2>Finding out which members are overdue with their payments</h2>
<p>Issue the following command:</p>
<pre class="literal-block">
python ti.py --format &quot;Joined: %j, Paid until: %p, Name: %N, Email: %m&quot; --search --nick &quot;%&quot; --restrict overdue --active-only
</pre>
<p>Or, in a more parseable format:</p>
<pre class="literal-block">
python ti.py --format &quot;%j, %p, %N, %m&quot; --search --nick &quot;%&quot; --restrict overdue --active-only
</pre>
<p>Or, to list their payments as well (doesn't parse nicely):</p>
<pre class="literal-block">
scripts/overdue.sh
</pre>
</div>
</div>
<div class="section" id="bank-imports">
<h1>Bank imports</h1>
<p>One of the important aspects of the TechInc treasury is semi-automatically
processing payments made by members. This way the members will not forget to pay
for their membership and estimates can be made based on monthly income. This
document is supposed to aid the treasurer in using the financial system.</p>
<div class="section" id="mt940-and-identification">
<h2>MT940 and identification</h2>
<p>MT940 is one of the formats used by banks. Our code is able to parse MT940 bank
exports - within reason; the MT940 format is quite terrible. We can succesfully
parse descriptions, amounts and dates. To identify members by the transactions
we typically require them to add the following to their payment description:</p>
<pre class="literal-block">
MEMBERSHIP: &lt;NICKNAME&gt;
</pre>
<p>Checking for names or IBAN identification of a member is not enough; as
sometimes members will pay on behalf of other members (who cannot do bank
transfers), in which case just matching on an IBAN account would result in false
matches. Another case where matching on just IBAN is poor would be when a member
would pay to TechInc for a reason other than paying for membership. The payment
description is very important to make your life as TechInc treasurer simple, so
do ask members to add such a description, and preferrably make their payments
automated and recurring.</p>
</div>
<div class="section" id="parsing">
<h2>Parsing</h2>
<p>Parsing is done in two steps; the first step is the automated processing and
converting of the MT940 format to JSON. This step will try to find out which
transactions are payments by members. Once this automated step is complete, the
treasurer is required to manually verify that the tool did a proper job and
possible perform a few manual steps to process transactions previously not
recognised or by definition unrecognisable.</p>
<p>If required, convert it to utf-8:</p>
<pre class="literal-block">
recode iso-8859-1..utf-8 MT940140331144020.STA
</pre>
<p>The file mt940/mt940.py can parse MT940 formats. It will also attempt to
recognise which member made what payment, within reason. It uses a (private)
members_strings.py file which maps certain payments to members based on simple
string searches. It will output payments recognised to stdout; whereas unknown
payments are output to stderr. Usage would be like this:</p>
<pre class="literal-block">
$ python mt940.py MT940140331144020.STA  1&gt;accept.json 2&gt;reject.json
</pre>
<p>Where <tt class="docutils literal">accept.json</tt> will now contain all the recognised payments, in
JSON format.
The <tt class="docutils literal">reject.json</tt> file contains the other (not immediately) recognised
payments, also in JSON format.</p>
<p>Optionally, you can have the mt940.py script ignore certain hashes (where each
line contains a hash), like so:</p>
<pre class="literal-block">
$ python mt940.py MT940140331144020.STA file_with_hashes_to_ignore.txt 1&gt;accept.json 2&gt;reject.json
</pre>
<p>The JSON format contains the following entries:</p>
<ul class="simple">
<li>nick: This is the nickname of the member</li>
<li>date: The date of the payment</li>
<li>amount: The amount paid in the transaction</li>
<li>months: The amouth of months that was paid for in one go. This defaults to '1'
and <strong>is to be changed by the treasurer when required</strong>.</li>
<li>hash: This SHA256-hash is generated to be able to uniquely identify payments;
this makes it possible to recognise if a payment was already processed, and
either warn the treasurer or even ignore the payment all together.</li>
</ul>
<p>An example:</p>
<pre class="literal-block">
{
    &quot;hash&quot;: &quot;b717ec481b3a84f1faa36c3344af2f70348b84ebd8ef1e471786c4100fa70e6c&quot;,
    &quot;months&quot;: 1,
    &quot;nick&quot;: &quot;wizzup&quot;,
    &quot;amount&quot;: 42.0,
    &quot;date&quot;: &quot;2014-01-02&quot;,
    &quot;desc&quot;: &quot;/TRTP/SEPA OVERBOEKING/IBAN/NL28TRIO0XXXXXXXXX/BIC/TRIONL2U/NAME/M.B.W. WAJER/REMI/MEMBERSHIP WIZZUP/EREF/TRIODOS/NL/20140101/13XXXXXX&quot;
}
</pre>
<div class="section" id="the-accept-and-reject-files">
<h3>The accept and reject files</h3>
<p>The accept and reject files contain payments recognised and not recognised,
respectively. The treasurer is <strong>required to verify both files</strong>; the
accept file for any months that need changing, and the reject file for any
transactions that were not recognised but are a membership payment. Once the
treasurer has identified payments in the reject file that need to processed, the
is encouraged to add remove the specific part of the JSON from the reject file
and place them in the accept file.</p>
<p>Optionally, if the treasurer is unsure about certain transactions, he can remove
them from either (or both) <tt class="docutils literal">accept.json</tt> and <tt class="docutils literal">reject.json</tt> and place them in
<tt class="docutils literal">todo.json</tt>. <strong>The todo.json file should not be removed until all the
transactions in there have been taken care of; either by processing them or
deeming them irrelevant.</strong></p>
<p>Once this manual labour is done, the end result should be:</p>
<ul class="simple">
<li>An <tt class="docutils literal">accept.json</tt> file which contains all the transactions that are
membership payments that need to be processed and added to the database.</li>
<li>An <tt class="docutils literal">reject.json</tt> file which contains transactions irrelevant to membership
payments.</li>
<li>Optionally a <tt class="docutils literal">todo.json</tt> file <strong>or payments that need to be processed at a later time.</strong></li>
</ul>
<p>I will stress it once more, it is important to NOT remove the <tt class="docutils literal">todo.json</tt>
file unless you are sure it can be removed.</p>
</div>
<div class="section" id="on-recognising-previous-payments">
<h3>On recognising previous payments</h3>
<p>It may very well happen that you process a MT940 file which contains previously
analysed transactions. Be it transactions that are already-processed membership
payments or transactions that were not relevant. The system gives you a way to
automatically discard both; as they are not relevant - because they have been
already processed or were already deemed irrelevant.</p>
<p>Transactions already processed will have their hash available in the database,
the import tool has the option to discard payments with an existing hash;
because they have already been taken care of.</p>
<p>Ignoring transactions previously deemed invalid is a slightly more work, at
least at this point. It requires you to <strong>save the hashes from all your previous
(final) ``reject.json`` files.</strong> This can be done as follows:</p>
<pre class="literal-block">
$ mt940/filter_reject.sh reject.json &gt;&gt; reject_hashes_store
</pre>
<p>And for the net import, the <strong>reject_hashes_store</strong> file can be using during the
<cite>mt940.py</cite> step.</p>
</div>
</div>
<div class="section" id="importing-accept-json-data">
<h2>Importing accept.json data</h2>
<p>A basic import looks as follows:</p>
<pre class="literal-block">
$ python import.py -f accept.json
</pre>
<p>This will process the accept.json file and check for any errors. <strong>Note that is
does not yet add the payments to the database!</strong>. To actually import the data,
issue the following command (note the <tt class="docutils literal"><span class="pre">-i</span></tt> flag):</p>
<pre class="literal-block">
$ python import.py -f accept.json -i
</pre>
<p>If you have worked on a <tt class="docutils literal">todo.json</tt>; you can pass <tt class="docutils literal">todo.json</tt> as argument
with <tt class="docutils literal"><span class="pre">-f</span></tt> instead.</p>
</div>
<div class="section" id="importing-a-recap">
<h2>Importing, a recap</h2>
<p>First, process the MT940 data:</p>
<pre class="literal-block">
$ python mt940.py MT940140331144020.STA [reject_hashes_store] 1&gt;accept.json 2&gt;reject.json
</pre>
<p>Then, manually inspect and modify the <tt class="docutils literal">accept.json</tt>, <tt class="docutils literal">reject.json</tt> and
optionally <tt class="docutils literal">todo.json</tt>. Finally, import it to the database:</p>
<pre class="literal-block">
$ python import.py -f accept.json -i
</pre>
</div>
</div>
</div>
</body>
</html>
